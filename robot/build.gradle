apply plugin: 'idea'

sourceSets {
    codegen {
        kotlin.srcDir 'src/codegen/kotlin'
    }
    main.kotlin.srcDirs += "build/generated-sources"
}

idea.module {
    scopes.PROVIDED.plus += [configurations.codegenCompileClasspath]
}

dependencies {
    api project(':game')

    codegenImplementation project(':game')
    codegenImplementation Deps.KotlinPoet4Groovy
}

task generateCode(type: JavaExec) {
    mainClass = 'play.example.robot.codegen.Generator'
    classpath = sourceSets.codegen.runtimeClasspath
    args "${buildDir}/generated-sources/"

    outputs.upToDateWhen { !tasks.compileCodegenJava.didWork }
    outputs.dir "${buildDir}/generated-sources/"
    outputs.cacheIf { true }
}
compileJava.dependsOn(generateCode)
compileKotlin.dependsOn(generateCode)